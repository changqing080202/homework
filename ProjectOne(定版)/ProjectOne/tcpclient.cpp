#include "tcpclient.h"

TcpClient::TcpClient(QWidget *parent) : QWidget(parent)
{

    //创建IP输入栏
    this->editId=new QLineEdit(this);
    this->editId->move(100,25);
    this->editId->resize(100,25);
    this->editId->setText("127.0.0.1");
    //创建IP标签栏
    QLabel *textId = new QLabel(this);
    textId->move(75,25);
    textId->resize(25,25);
    textId->setText("IP:");

    //创建端口号输入栏
    this->editName=new QLineEdit(this);
    this->editName->move(100,75);
    this->editName->resize(100,25);
    this->editName->setText("10001");
    //创建端口号标签栏
    QLabel *textName = new QLabel(this);
    textName->move(60,75);
    textName->resize(50,25);
    textName->setText("Port:");

    //创建信息发送按钮
    this->btnSendCmd=new QPushButton(this);
    this->btnSendCmd->move(100,130);
    this->btnSendCmd->setText("Link");

    connect(this->btnSendCmd,&QPushButton::clicked,this,TcpClient::Send);
    timer = new QTimer(parent);
    mClient = new QTcpSocket(); // 构建QTcpSocket实例
    mClient->connectToHost(QHostAddress(this->editId->text()),this->editName->text().toInt()); // 连接远程主机<ip:port> 将字符串形式的ip转换为QHostAddress类型，同时使用形参port来指示远程主机的端口
    // 初始化发送缓冲区
    //mClient->waitForConnected()// 等待连接建立


}
void TcpClient::Send()
{

    connect(timer, &QTimer::timeout, this, TcpClient::TcpClientLink);
    timer->start(10);
}

void TcpClient::TcpClientLink()
{
    mClient->connectToHost(QHostAddress(this->editId->text()),this->editName->text().toInt());
    if(mClient->waitForConnected())
    {
        QString tx_buf;


        int ecgWave[500] = {
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2008, 2016, 2016, 2016, 2024, 2032, 2048,
                2064, 2064, 2064, 2072, 2080, 2080, 2080, 2088, 2096, 2104,
                2112, 2112, 2112, 2112, 2112, 2112, 2104, 2096, 2088,
                2080, 2080, 2080, 2072, 2064, 2064, 2064, 2048, 2032, 2032,
                2032, 2016, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 1992, 1984, 1976,
                1968, 1960, 1952, 1944, 1936, 1944, 1952, 2016, 2080, 2136,
                2192, 2256, 2320, 2376, 2432, 2488, 2544, 2568, 2592, 2536,
                2480, 2424, 2368, 2304, 2240, 2184, 2128, 2072, 2016, 1968,
                1920, 1928, 1936, 1944, 1952, 1960, 1968, 1984, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2008, 2016, 2024, 2032, 2032,
                2032, 2048, 2064, 2064, 2064, 2072, 2080, 2088, 2096, 2104,
                2112, 2112, 2112, 2120, 2128, 2136, 2144, 2152, 2160, 2160,
                2160, 2160, 2160, 2168, 2176, 2176, 2176, 2184, 2192,
                2192, 2192, 2192, 2200, 2208, 2208, 2208, 2208, 2208, 2208,
                2208, 2200, 2192, 2192, 2192, 2184, 2176, 2176, 2176, 2168,
                2160, 2160, 2160, 2144, 2128, 2128, 2128, 2128, 2128, 2112,
                2096, 2088, 2080, 2072, 2064, 2064, 2064, 2048, 2032, 2024,
                2016, 2016, 2016, 2008, 2000, 2000, 2000, 2000, 2000,
                2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000};


        if(cnt < 499)
        {
            tx_buf = QString::number(ecgWave[cnt]);
            cnt = cnt+3;
        }else
        {
            tx_buf = QString::number(ecgWave[499]);
            cnt = 1;
        }
        mClient -> write(tx_buf.toLocal8Bit()); // 用toLocal8Bit编码发送数据

    }
}
